<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="222222"/><link rel="alternate" href="/atom.xml" title="K1rit0's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://tearsjin.github.io/page/4/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>K1rit0's Blog</title>
  <meta name="generator" content="Hexo 5.4.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">K1rit0's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a><a href="/link/">
        <li class="mobile-menu-item">Link
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">K1rit0's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/link/">
            Link
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2021/04/17/writeup-for-2021-MRCTF/">writeup for 2021 MRCTF</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-04-17
        </span><span class="post-category">
            <a href="/categories/WriteUp/">WriteUp</a>
            </span>
        </div>
    </header>

    <div class="post-content"><blockquote>
<p>啊比赛的时候刚好和npy出去玩了, 也没怎么看题, 就看了半个下午的Common prime rsa. 也没整出来.<br>最近又在忙学校的HW<del>就是什么成果都没, 只能看着大佬干自己划水的那种</del>. 所以题目复现什么的就慢了好多.<br>慢慢的更新完吧, 每次做题都一堆paper, 想慢慢的看完只能花多点时间了吧</p>
</blockquote>
<h1 id="Strange-GCD"><a href="#Strange-GCD" class="headerlink" title="Strange_GCD"></a>Strange_GCD</h1><h2 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> urandom</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line">P_bits = <span class="number">444</span></span><br><span class="line">Q_bits = <span class="number">666</span></span><br><span class="line">R_bits = <span class="number">333</span></span><br><span class="line">key_num = <span class="number">9</span></span><br><span class="line">e = <span class="number">0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    could_not_solve = <span class="literal">False</span></span><br><span class="line">    p = getPrime(P_bits)</span><br><span class="line">    <span class="keyword">if</span> gcd(p-<span class="number">1</span>, e) != <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    R = []</span><br><span class="line">    Q = []</span><br><span class="line">    N = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(key_num):</span><br><span class="line">        Q.append(getPrime(Q_bits))</span><br><span class="line">        R.append(getrandbits(R_bits))</span><br><span class="line">        N.append(p * Q[-<span class="number">1</span>] + R[-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> gcd(Q[-<span class="number">1</span>], e) != <span class="number">1</span>:</span><br><span class="line">            could_not_solve = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> could_not_solve:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C = []</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) == <span class="number">45</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(key_num):</span><br><span class="line">    tmp_cipher = flag[i*<span class="built_in">len</span>(flag)//key_num:(i+<span class="number">1</span>)*<span class="built_in">len</span>(flag)//key_num].encode()</span><br><span class="line">    tmp_cipher = urandom(<span class="number">128</span> - <span class="built_in">len</span>(tmp_cipher)) + tmp_cipher</span><br><span class="line">    tmp_cipher = <span class="built_in">pow</span>(bytes_to_long(tmp_cipher), e, p * Q[i])</span><br><span class="line">    C.append(tmp_cipher)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;N =&#x27;</span>, N)</span><br><span class="line">print(<span class="string">&#x27;C =&#x27;</span>, C)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">N = [...]</span></span><br><span class="line"><span class="string">C = [...]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="analyses"><a href="#analyses" class="headerlink" title="analyses"></a>analyses</h2><p>这题比完赛以后做的, paper也是直接就看别人找了<del>自己找太浪费时间啦</del></p>
<p>做的时候没看paper, 造格子没去思考怎么消去比较大的项, 看了paper才明白, </p>
<h3 id="AGCD"><a href="#AGCD" class="headerlink" title="AGCD"></a>AGCD</h3><p>先来看看这边的公钥生成, 这共生成了9个$N_i = p \cdot q_i + r_i,i=0,1,…,8$<br>其中$p,q,r$的位数分别为$444,666,333$, 这个问题看着像LWE但是我们只知道$N_i$. 尝试了一下造格子也没啥结果, 找paper找到了这个-&gt; <a target="_blank" rel="noopener" href="https://martinralbrecht.wordpress.com/2020/03/21/the-approximate-gcd-problem/">The Approximate GCD Problem</a> 这里面提供了一个造格子的方法来分解$N_i$</p>
<blockquote>
<p>其实这里面就有一种造格子的思想吧? 我们想要通过格基规约得出结果, 那么我们必须保证我们需要求出的量不会很大(只有这样才能使得我们要求的向量是最短向量), 所以我们的一个思路, 可以是消去一些比较大的数, 留下一些比较小的.</p>
</blockquote>
<p>在这里我们先拿两行等式来分析<br>$$<br>N_0 = p \cdot q_0 + r_0 \\<br>N_1 = p \cdot q_1 + r_1<br>$$<br>我们可以看到式子里有个非常大的$p,q$, 可以想个办法消去这个大的项并且不引入比他更大的项. 一个办法就是通过减法!<br>$$<br>N_1q_0 - N_0q_1 = r_1q_0 - r_0q_1 \tag 1<br>$$<br>通过减法可以将$1110 $ bits的$pq$变成了小一点的$999$ bits 的$r_1q_0 - r_0q_1$, 这里小了点就可以尝试做文章了. 我们可以根据$(1)$这个式子写出剩下的一样的式子<br>$$<br>\begin{cases}<br>N_1q_0 - N_0q_1 = r_1q_0 - r_0q_1 \\<br>N_2q_0 - N_0q_2 = r_2q_0 - r_0q_2 \\<br>\vdots \\<br>N_8q_0 - N_0q_8 = r_8q_0 - r_0q_8<br>\end{cases}<br>$$<br>根据这个式子, 可以造出格子<br>$$<br>(q_0,q_1,…,q_8)<br>\begin{pmatrix}<br>2^\lambda&amp;N_1&amp;N_2&amp;\cdots&amp;N_8 \\<br>0&amp;-N_0&amp;0&amp;\cdots&amp;0 \\<br>0&amp;0&amp;-N_0&amp;\cdots&amp;0 \\<br>0&amp;0&amp;0&amp;\ddots&amp;0 \\<br>0&amp;0&amp;0&amp;\cdots&amp;-N_0<br>\end{pmatrix}<br>=<br>(2^\lambda q_0,r_1q_0-r_0q_1,…,r_8q_0-r_0q_8)<br>$$</p>
<h3 id="lambda-的取值"><a href="#lambda-的取值" class="headerlink" title="$\lambda$ 的取值"></a>$\lambda$ 的取值</h3><p>这里有个参数$\lambda$需要确定下来, 这个参数跟最短向量的上界有关, 一直以来这个参数都是用来调目标向量长度和格的行列式用的, 也没有具体的分析过, 每次做的时候都直接爆破, 这次慢慢分析了一下.</p>
<p>先来看我们要求的向量, 暂时记为$v$<br>$$<br>\begin{align}<br>||v|| &amp; = \sqrt{(2^\lambda q_0)^2 + (r_1q_0-r_0q_1)^2 + \cdots +(r_8q_0-r_0q_8)^2} \\<br>&amp; \approx \sqrt{2^{2\lambda+1332}+2^{1998}+\cdots+2^{1998}} \\<br>&amp; = \sqrt{2^{2\lambda+1332}+2^{2001}} \\<br>&amp; \approx<br>\begin{cases}<br>2^{1001} , \lambda \le 335 \\<br>2^{\lambda + 666} , \lambda &gt;335<br>\end{cases}<br>\end{align}<br>$$<br>再来看看$det(L)$</p>
<p>$$<br>det(L)  = 2^\lambda \cdot N_0^8 \approx 2^{\lambda+8880}<br>$$<br>格子是9维的, 那么我们可以有一个粗略的不等式 $||v|| \le det(L)^{1/9}$<br>通过简单的计算就可以得到<br>$$<br>129 &lt; \lambda &lt; 360 \tag 2<br>$$<br>得到参数的大概取值范围, 选一个中间的就行了, <del>想刺激一点可以试试130 359之类的(反正我试了都是可以的).</del></p>
<blockquote>
<p>(2) 式只是粗略得到的, 因为上界还有更严格的条件而且LLL算法实际上要比理论上要好….</p>
</blockquote>
<p>我们构造出格子并规约后就能得到$q_0$了, 剩下的就是仿造这个格子构造求$q_1,\cdots,q_8$的格子, 求出所有的$q$以后, 因为$q&gt;r$ , 所以$N = r \mod q$, 直接就可以求出$r$了, 继续求出$p$,然后就是正常的RSA解密了.</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line">N = [...]</span><br><span class="line">C = [...]</span><br><span class="line">Q = []</span><br><span class="line">R = []</span><br><span class="line">D = []</span><br><span class="line">t = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    M = <span class="number">2</span>^<span class="number">130</span></span><br><span class="line">    L = [[<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>)]</span><br><span class="line">    L[<span class="number">0</span>] = [M]+N[<span class="number">0</span>:t] + N[t+<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        L[i][i] = - N[t]</span><br><span class="line">    L[<span class="number">0</span>][<span class="number">0</span>] = M</span><br><span class="line">    MQ = <span class="built_in">abs</span>(matrix(L).LLL()[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">assert</span>  MQ % M == <span class="number">0</span></span><br><span class="line">    Q.append(MQ // M)</span><br><span class="line">    t+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n,q <span class="keyword">in</span> <span class="built_in">zip</span>(N,Q):</span><br><span class="line">    R.append(n % q)</span><br><span class="line"></span><br><span class="line">p = (N[<span class="number">0</span>] - R[<span class="number">0</span>]) // Q[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    phi = (p-<span class="number">1</span>) * (Q[i]-<span class="number">1</span>)</span><br><span class="line">    D.append(inverse_mod(<span class="number">0x1337</span>,phi))</span><br><span class="line"><span class="keyword">for</span> c,d,q <span class="keyword">in</span> <span class="built_in">zip</span>(C,D,Q):</span><br><span class="line">    print(long_to_bytes(<span class="built_in">pow</span>(c,d,p*q))[-<span class="number">5</span>:].decode(),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="Common-Prime-RSA"><a href="#Common-Prime-RSA" class="headerlink" title="Common_Prime_RSA"></a>Common_Prime_RSA</h1><h2 id="problem-1"><a href="#problem-1" class="headerlink" title="problem"></a>problem</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_my_prime</span>(<span class="params">nibt, gamma</span>):</span></span><br><span class="line">    g = getPrime(<span class="built_in">int</span>(nibt * gamma))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        p = <span class="number">2</span> * g * getPrime(<span class="built_in">int</span>(nibt * (<span class="number">0.5</span> - gamma))) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(p):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        q = <span class="number">2</span> * g * getPrime(<span class="built_in">int</span>(nibt * (<span class="number">0.5</span> - gamma))) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> isPrime(q):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">2</span> * p &gt; q <span class="keyword">and</span> <span class="number">2</span> * q &gt; p</span><br><span class="line">    <span class="keyword">return</span> p, q, g</span><br><span class="line"></span><br><span class="line">p1, q1, g1 = get_my_prime(<span class="number">1024</span>, <span class="number">0.2247</span>)</span><br><span class="line">p2, q2, g2 = get_my_prime(<span class="number">1024</span>, <span class="number">0.3247</span>)</span><br><span class="line">n1 = p1 * q1</span><br><span class="line">n2 = p2 * q2</span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hex</span>(n1))</span><br><span class="line"><span class="comment"># 0x48b11209b62c5bc580d00fc94886272b92814ce35fcd265b2915c6917a299bc54c2c0603c41f8bf7c8f6f2a545eb03d38f99ec995bf6658bb1a2d23056ee21c7230caa2decec688ea9ee00b0d50b39e8cd23eb2c3ddeb20f5ab26777b80052c171f47b716e72f6aee9cece92776fc65119046f9a1ad92c40e2094d7ed7526d49</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hex</span>(<span class="built_in">pow</span>(bytes_to_long(<span class="string">b&#x27;Common prime RSA is a variant of RSA&#x27;</span> + long_to_bytes(g1) + <span class="string">b&#x27;And the common factor g is large prime and p=2ga+1 q=2gb+1&#x27;</span>), <span class="number">3</span>, n1)))</span><br><span class="line"><span class="comment"># 0x27d8d7249643668ffc115be8b61775c60596e51f6313b47ad5af8493526922f5e10026a2cdaef74e22c3eec959dd8771abe3495b18d19f97623f5a3f65f22ff8fc294fc37ceb3b43ebbbf8a9bcf622922e22c5520dbd523483b9dc54fdffcd1a1b3f02ca1f53b75413fb79399ca00034f2acf108ac9a01bd24d2b9df6e27d156</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hex</span>(<span class="built_in">pow</span>(g2, <span class="number">65537</span>, n1)))</span><br><span class="line"><span class="comment"># 0xeaf06b9050a809659f962251b14d6b93009a7010f0e8d8f0fa4d71591757e98243b8ff50ec98a4e140fd8a63bbb4b8bb0a6d302a48845b8b09d1e40874fcb586ddccbb0bbf86d21540ec6c15c1d2bf925942f6f384fdc1baae7f8e06150ccd9459eb65d0f07eea16a911fa0a17e876a145dbfec83537ca2bee4641897b9f7f5</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hex</span>(n2))</span><br><span class="line"><span class="comment"># 0x6d457110d6044472d786936acbd3cd93c7728daa3343b35ccaa5c55eba6b35c28c831bb245b8cdd8fc8cb67a72f57e62a0e1259f5e804c487a8478f6895b302d39277bd73947598a5f8ec0a535be9e9a4d34df91df948ee44cc3d13d14e23b9651089e4767c7f0e7245df55619c92fe24483225d35f5f3ee6f74375065766ffd</span></span><br><span class="line"></span><br><span class="line">print(<span class="built_in">hex</span>(<span class="built_in">pow</span>(bytes_to_long(flag.encode()), <span class="number">65537</span>, n2)))</span><br><span class="line"><span class="comment"># 0x15be2b0eaef8837a753587c47d3f31696a7d239d88837a9b7d903cd0d0648ef8e225ea555402693a23f305d19e7e13905be61b44c651dba5b26614bcf876234e765a724e0ed8af4a4e408e6a233c48ab9cc63e9c552ef9cd1999512aa0aca830fe6cbcbcc3c6bb354903124a2c3a12d442cdbdefdae6576f4bbc1515051b7111</span></span><br></pre></td></tr></table></figure>

<h2 id="analyses-1"><a href="#analyses-1" class="headerlink" title="analyses"></a>analyses</h2><p>这道题做的时候自己踩了坑, 也没做出来, 后面看wp找到了那个paper才大概明白, 关于界的确定还得谢谢d33师傅.</p>
<h3 id="coppersmith"><a href="#coppersmith" class="headerlink" title="coppersmith"></a>coppersmith</h3><p>这题的第一个problem就是求解$g_1$, 第一个明文可以分成三部分<br>$$<br>Plaintext_1 = high | g_1 | low \tag 1<br>$$<br>$high$和$low$我们都是知道的, 而$g1$和$low$的位数分别为$230,463$</p>
<p>所以理论上$(1)$式可以写成<br>$$<br>Plaintext_1 = 2^{693} \cdot high + 2^{463}\cdot g_1 + low<br>$$<br>这里就有个坑了, 字符串在拼接的时候肯定都是完整的字节在拼的, 所以每一段的位数都应该是8的倍数才对, 所以正确的$(1)$式应该为:<br>$$<br>Plaintext_1 = 2^{696} \cdot high + 2^{464} \cdot g_1 + low<br>$$<br> $g_1$的位数为$230$, 是满足coppersmith的条件的.</p>
<p>我们记$mbar = 2^{696}\cdot high + low$, 那么就有$c_1 = (mbar+2^{464}\cdot g_1)^3 \mod n_1$, 化成首一多项式后coppersmith method即可求出$g_1$</p>
<h3 id="further-attacks-on-server-aided-rsa"><a href="#further-attacks-on-server-aided-rsa" class="headerlink" title="further attacks on server-aided rsa"></a>further attacks on server-aided rsa</h3><p>我们从上部分得到了$g_1$ , 我们可以看看$p,q$和$g$的关系, 为了方便讨论, 直接记$g = 2g_1$<br>$$<br>p = xg+1 \\<br>q = yg+1<br>$$<br>那么我们有<br>$$<br>{N - 1 \over g} = xyg + (x+y) \tag 2<br>$$<br>这里设$xy = u - c, x+y =v+cg$, 那么$(2)$式可以化成<br>$$<br>{N - 1 \over g} = ug+v<br>$$<br>这里的$v &lt; g$ , 也就是把$v$看成是${N-1\over g }\mod g$的结果. 那么$u,v$都是可以计算出来的, 重点在于新引入的$c$, 求出$c$就可以求$p,q$了</p>
<p>paper里提供了一种利用bsgs<del>北上广深</del>思想的方法来求出这个c, 但这题跟paper在c的界上有区别.</p>
<blockquote>
<p>原paper是这样的, 我们随便找一个素数$a$ , 观察下面的式子<br>$$<br>a^{ug} \equiv a^{xyg+cg} \equiv a^{cg} \mod N<br>$$<br>为什么$a^{xyg}$没有了呢? 因为$k \cdot lcm(p-1,q-1) = xyg$ .</p>
<p>然后求一下$c$的上界, 后面要用到<br>$$<br>\begin{align}<br>&amp;\because x+y  =v+ cg \\<br>&amp;\therefore x+y &gt; cg \\<br>&amp;\because x,y \approx {\sqrt{N} \over g} \\<br>&amp;\therefore  cg &lt; {2 \sqrt{N} \over g} \\<br>&amp;\therefore 0&lt;c &lt; {2 \sqrt{N} \over g^2}<br>\end{align}<br>$$<br>记$b = a^g \mod N$, 我们有$b^u \equiv b^c \mod N$ , paper里提到了这个$u,c$是很大概率相等的, 有师傅知道为什么吗?<br>所以我们可以用bsgs的思想, 计算两组数.<br>$$<br>\begin{align}<br>&amp; b^0,b^D,b^{2D},\cdots,b^{D^2} \mod N \\<br>&amp; b^u,b^{u-1},b^{u-2},\cdots,b^{u-D} \mod N<br>\end{align}<br>$$<br>其中$D = \lfloor \sqrt{ {2 \sqrt N \over g^2}-0}\rceil$</p>
<p>在这两组数中搜索碰撞, 也就是$b^{u-i} \equiv b^{kD} \mod N$ . 找到碰撞以后就可以计算$c = kD + i$了, 有了$c$就可以分解$N$了</p>
</blockquote>
<p>当我看完paper以后兴奋的写了$exp$, 却发现这个北上广深把我内存全部吃完都没有结果(早上起来发现电脑屏幕都打不开了….<br>怎么会没结果啊…只能去看<a target="_blank" rel="noopener" href="https://d33b4t0.com/">d33</a>师傅的wp了! 因为他什么都会, 看完才明白原来paper里的界太松散了, 导致$D$太大, 跑出来需要多几根内存才行, 可是我只有一根8G的内存. </p>
<p>d33师傅的界:</p>
<p>因为$p,q$的位数相同, 所以我们还有一个隐藏的关系式<br>$$<br>p&gt;2q \implies x &lt; 2y \tag3 \implies {x\over 2}&lt; y<br>$$<br>这个式子很重要, 我们继续观察一下$x+y$和$c$的关系$x+y -v  = cg$, 我们可以根据基本不等式写出上界, 再根据$(3)$式写出下界<br>$$<br>{ 3\sqrt N \over 2g } - v\approx {3\over 2}x-v\leq cg \leq 2 \sqrt{xy} - v \approx {2\sqrt N \over g} -v<br>$$<br>根据这个, 咱们就有一个更加严格的$c$的界<br>$$<br>c \in [ { 3\sqrt N - 2gv\over 2g^2 },{2\sqrt N - gv \over g^2} ]<br>$$<br>同样的, 计算$D = \lfloor {2\sqrt N - gv \over g^2}- { 3\sqrt N - 2gv\over 2g^2 }  \rceil $, 再用bsgs就可以求出$c$了, <del>但我8G的小内存依旧跑不出来</del>, 只能借用一下d33师傅的数据了</p>
<p>分解了$n_1$就能求出$g_2$, 由于$g_2$的位数比较大, $g_2 &gt; x+y$, 直接就有:<br>$$<br>{n_2 - 1 \over 2g_2} = x+y \mod 2g_2<br>$$<br>$xy$也可以直接求出来了, 然后依旧是分解$n_2$, 就可以求出flag了</p>
<h2 id="epx"><a href="#epx" class="headerlink" title="epx"></a>epx</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes <span class="keyword">as</span> l2b,bytes_to_long <span class="keyword">as</span> b2l</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> iroot</span><br><span class="line">n1 = <span class="number">0x48b11209b62c5bc580d00fc94886272b92814ce35fcd265b2915c6917a299bc54c2c0603c41f8bf7c8f6f2a545eb03d38f99ec995bf6658bb1a2d23056ee21c7230caa2decec688ea9ee00b0d50b39e8cd23eb2c3ddeb20f5ab26777b80052c171f47b716e72f6aee9cece92776fc65119046f9a1ad92c40e2094d7ed7526d49</span></span><br><span class="line">n2 = <span class="number">0x6d457110d6044472d786936acbd3cd93c7728daa3343b35ccaa5c55eba6b35c28c831bb245b8cdd8fc8cb67a72f57e62a0e1259f5e804c487a8478f6895b302d39277bd73947598a5f8ec0a535be9e9a4d34df91df948ee44cc3d13d14e23b9651089e4767c7f0e7245df55619c92fe24483225d35f5f3ee6f74375065766ffd</span></span><br><span class="line">c1 = <span class="number">0x27d8d7249643668ffc115be8b61775c60596e51f6313b47ad5af8493526922f5e10026a2cdaef74e22c3eec959dd8771abe3495b18d19f97623f5a3f65f22ff8fc294fc37ceb3b43ebbbf8a9bcf622922e22c5520dbd523483b9dc54fdffcd1a1b3f02ca1f53b75413fb79399ca00034f2acf108ac9a01bd24d2b9df6e27d156</span></span><br><span class="line">c2 = <span class="number">0xeaf06b9050a809659f962251b14d6b93009a7010f0e8d8f0fa4d71591757e98243b8ff50ec98a4e140fd8a63bbb4b8bb0a6d302a48845b8b09d1e40874fcb586ddccbb0bbf86d21540ec6c15c1d2bf925942f6f384fdc1baae7f8e06150ccd9459eb65d0f07eea16a911fa0a17e876a145dbfec83537ca2bee4641897b9f7f5</span></span><br><span class="line">c3 = <span class="number">0x15be2b0eaef8837a753587c47d3f31696a7d239d88837a9b7d903cd0d0648ef8e225ea555402693a23f305d19e7e13905be61b44c651dba5b26614bcf876234e765a724e0ed8af4a4e408e6a233c48ab9cc63e9c552ef9cd1999512aa0aca830fe6cbcbcc3c6bb354903124a2c3a12d442cdbdefdae6576f4bbc1515051b7111</span></span><br><span class="line">a = b2l(<span class="string">b&#x27;Common prime RSA is a variant of RSA&#x27;</span>) &lt;&lt; <span class="number">696</span></span><br><span class="line">b = b2l(<span class="string">b&#x27;And the common factor g is large prime and p=2ga+1 q=2gb+1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mbar = a+b</span><br><span class="line">R.&lt;x&gt; = Zmod(n1)[]</span><br><span class="line">f = ((<span class="number">2</span>^<span class="number">464</span>) * x + mbar) ^ <span class="number">3</span> - c1</span><br><span class="line">f = f.monic()</span><br><span class="line">g1 = <span class="built_in">int</span>(f.small_roots(X=<span class="number">2</span>^<span class="number">230</span>,beta=<span class="number">1</span>)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">beta = <span class="number">2</span>* g1</span><br><span class="line">v = ((n1 - <span class="number">1</span>) // beta)% beta</span><br><span class="line">u = ((n1 - <span class="number">1</span>) // beta - v) // beta</span><br><span class="line">b = <span class="built_in">pow</span>(<span class="number">2</span>,beta,n1)</span><br><span class="line">left = (<span class="number">2</span>*<span class="built_in">int</span>(sqrt(n1))//beta-<span class="number">2</span>-v)//beta </span><br><span class="line">right = (<span class="number">3</span>*<span class="built_in">int</span>(sqrt(<span class="number">2</span>)*sqrt(n1))//(<span class="number">2</span>*beta) - <span class="number">2</span> - v )//beta </span><br><span class="line">D = <span class="built_in">int</span>(sqrt(right - left)) + <span class="number">1</span></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"><span class="comment">#  这部分应该是bsgs部分由于没办法跑出结果,无法确定自己的算法是否正确  #</span></span><br><span class="line"><span class="comment">#  所以就先不放出来了,想知道具体的可以找d33师傅的博客               #</span></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"></span><br><span class="line">c=left+<span class="number">698170</span>*D+<span class="number">5980588</span></span><br><span class="line">xy = u - c </span><br><span class="line">x_y = v + c * beta</span><br><span class="line">x = var(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">f = x^<span class="number">2</span> - x_y * x + xy</span><br><span class="line">x,y = f.roots()[<span class="number">0</span>][<span class="number">0</span>],f.roots()[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">p,q = x *beta+<span class="number">1</span>,y*beta+<span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> p*q == n1</span><br><span class="line">g2 = <span class="built_in">int</span>(<span class="built_in">pow</span>(c2,<span class="built_in">int</span>(inverse_mod(<span class="number">65537</span>,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))),n1))</span><br><span class="line">beta = <span class="number">2</span> * g2</span><br><span class="line">x_y = ((n2 - <span class="number">1</span>) // beta)% beta</span><br><span class="line">xy = ((n2 - <span class="number">1</span>) // beta - x_y) // beta</span><br><span class="line">x = var(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">f = x^<span class="number">2</span> - x_y * x + xy</span><br><span class="line">x,y = f.roots()[<span class="number">0</span>][<span class="number">0</span>],f.roots()[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">p,q = x *beta+<span class="number">1</span>,y*beta+<span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> p*q == n2</span><br><span class="line">l2b(<span class="built_in">pow</span>(c3,<span class="built_in">int</span>(inverse_mod(<span class="number">65537</span>,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))),n2))</span><br></pre></td></tr></table></figure>

<h1 id="Strange-CRT"><a href="#Strange-CRT" class="headerlink" title="Strange_CRT"></a>Strange_CRT</h1><blockquote>
<p>啊啊啊HW的报告还没写, 咕咕咕</p>
<p>to be continued….</p>
</blockquote>

        </div></article>
      <nav class="pagination"><a class="prev" href="/page/3/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    <a class="next" href="/page/5/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/tearsjin" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2020 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">K1rit0</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
