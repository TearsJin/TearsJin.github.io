<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="writeup for 2021VNCTF Crypto"/><meta name="keywords" content="Crypto, RSA, WirteUp, K1rit0's Blog" /><link rel="alternate" href="/atom.xml" title="K1rit0's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://tearsjin.github.io/2021/03/14/writeup-for-2021VNCTF/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>writeup for 2021VNCTF Crypto - K1rit0's Blog</title>
  <meta name="generator" content="Hexo 5.4.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">K1rit0's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">K1rit0's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">writeup for 2021VNCTF Crypto
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-03-14
        </span><span class="post-category">
            <a href="/categories/WirteUp/">WirteUp</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-wihtegive"><span class="toc-text">0x00 wihtegive</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#problem"><span class="toc-text">problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%B1%82-%E5%88%A9%E7%94%A8gcd-%E5%88%86%E8%A7%A3n"><span class="toc-text">第一层  利用gcd()分解n</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%B1%82-Boneh-Durfee-attack"><span class="toc-text">第二层  Boneh_Durfee attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%B1%82-Coppersmith%E2%80%99s-Short-pad-Attack"><span class="toc-text">第三层 Coppersmith’s Short-pad Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-strange-function"><span class="toc-text">0x01 strange function</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#problem-1"><span class="toc-text">problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-1"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-strange-function-revenge"><span class="toc-text">0x02 strange_function_revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#problem-2"><span class="toc-text">problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-2"><span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-fatcor"><span class="toc-text">0x03 fatcor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#problem-3"><span class="toc-text">problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-3"><span class="toc-text">exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-text">后记</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><p>这次比赛听说是签到难度, 就做了一下, 结果也没能ak (说简单都是骗人的…)<br>嗯… 会做的题也没什么收获, 硬要说的话, whitegive的第一层需要通过运算把已知的条件合在一起或者消去一些不可能求出的参数, 这个一直都是密码分析的基础吧, 来看看题吧</p>
<h1 id="0x00-wihtegive"><a href="#0x00-wihtegive" class="headerlink" title="0x00 wihtegive"></a>0x00 wihtegive</h1><h2 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(url)</span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p * q</span><br><span class="line">d = getPrime(<span class="number">256</span>)</span><br><span class="line">e = inverse(d,(p-<span class="number">1</span>)*(q-<span class="number">1</span>))</span><br><span class="line">c = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line"></span><br><span class="line">print(n)</span><br><span class="line">print(c)</span><br><span class="line"></span><br><span class="line">m = e</span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p * p * q</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">d = inverse(e,lcm(p,lcm(p-<span class="number">1</span>,q-<span class="number">1</span>)))</span><br><span class="line">c = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line">hint = <span class="built_in">pow</span>(d,e,n)</span><br><span class="line"></span><br><span class="line">print(n)</span><br><span class="line">print(c)</span><br><span class="line">print(hint)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">97814568264814384858194701955408461509880555772006698372422205341758322175891474378211599333051180365254844248340812534463000531890490435018379585036704801177155418066770861143206836558793774360498040810255823235715535487716966004194143204900564413879660115112965484824906920141847149888933004740523449213441</span></span><br><span class="line"><span class="string">86143311788363675684674113699193046781796638913243016152555572150858159500527674063754694514501999791875561142925154991000532628799185608465062814546108160434468098898040769021072007374156546314975240583347468026001633652940408779155579339470960571067652924814623371177901052302005289155305089588204204313261</span></span><br><span class="line"><span class="string">1246903000089073759886267722667196003041462505274526737638837808213476294697746018085346623497511017543801377442390781101585650581984057653018703031659844145960721073451379508212905335383758157379301019575213158532070229897587088955814288202279949391608732448294591675986989254272257059551622461096394217684402667140362275595245430242117193793913872208576714597860532581116390903216389172132085635891741189355461016795362341416848534340615825023292174042406128959</span></span><br><span class="line"><span class="string">952508462840095293368043281511747192551431448088755251878915582522463097721381421883702408853564036431155676272901680250701398946525803160765527940151587567521509500006089852079864042238196362897144754722623523621230744820970423076092319608853809407595863195726851921082224085255808985329769890887863865121647796115540376158135632760785321953364738008064130705467326745546629505023549047992509562623348749056757848144371814157305011884825502144329268299851210747</span></span><br><span class="line"><span class="string">788785744509676701442642497798353940704045062680685297430840370664093043099033424646382070232242765761123110381200239132310785932203252095093993313010883982078216697297202940152563278231011836966627537170460186597134847633828107444548759805274516431300662852153808962421740187067058018192457264083227110866080267684557127718769967184710395811547902947248700889674967381917907905535103547918375731341071557144999864774198881339085314424766509424492349867615604684</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Wow, you got here!</span></span><br><span class="line"><span class="comment"># This is the last task, trust me!</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag,padding</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">e = <span class="number">7</span> </span><br><span class="line"></span><br><span class="line">p = getPrime(<span class="number">512</span>)</span><br><span class="line">q = getPrime(<span class="number">512</span>)</span><br><span class="line">n = p * q</span><br><span class="line"></span><br><span class="line">c1 = <span class="built_in">pow</span>(m,e,n)</span><br><span class="line">c2 = <span class="built_in">pow</span>(m+padding,e,n)</span><br><span class="line"></span><br><span class="line">print(n)</span><br><span class="line">print(c1)</span><br><span class="line">print(c2)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">143224951702807798608353389056046982493788310072914995404719898237226283884553121669729599925829562704800197375580487019006702401282671268969358774635337351738915083955659230582177495821699251999928502338923489031347921151957398310960671307216790020399224115377846788378990638367296298663795893865325304226511</span></span><br><span class="line"><span class="string">74797173657575640598140788410852016843612519588375968190579734420951374103129570637822547217967978911328419808529204143522454142303138959013220811558490951614314306849367068478190797885056922705403028856734095288522290055309880572321557493798362056216783777593386133347693892941928131945986087712737862263761</span></span><br><span class="line"><span class="string">9209695919437085323423940852135308337887271742988391422139555924185234849146079306139570263602339983687993333013333937719071267190971983543492940032646907167417161479697805991443259327402389097539126399994414628326218438416138199892253597375493026563369334352434282120293396846427418323600336867792587721214</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>好家伙, 连Crypto都开始套娃了, 一共三层RSA, 做了前两层才能知道第三层</p>
<h2 id="第一层-利用gcd-分解n"><a href="#第一层-利用gcd-分解n" class="headerlink" title="第一层  利用gcd()分解n"></a>第一层  利用<code>gcd()</code>分解<code>n</code></h2><ul>
<li><code>e</code> : 65537</li>
<li><code>c</code>: 密文</li>
<li><code>hint</code>: $hint = d^e (mod \ n)$</li>
</ul>
<p>这题不算难, 仔细算一下就能知道这个<code>hint</code>有什么用了<br>首先看一下<code>d = inverse(e,lcm(p,lcm(p-1,q-1)))</code>, $p$都已经是素数了, 公倍数肯定是$kp$</p>
<p>那么我们就有<br>$$<br>e \cdot d = 1 (mod \ kp)<br>$$<br>把<code>hint</code>的式子和这个式子都改写成:<br>$$<br>e \cdot d  = 1 + k_1p \\<br>d^e = hint + k_2n<br>$$<br>联立一下就有:<br>$$<br>({k_1p+1 \over e})^e  = hint + k_2n \Rightarrow (k_1p+1) = e^e(hint + k_2n) \\<br>\Rightarrow (k_1-e^ek_2q)p = e^e \cdot hint - 1<br>$$<br>取个<code>gcd(e**e * hint - 1,n)</code>, 就可以有<code>p</code>了, 分解<code>n</code>就好做了, 这一层还是挺有意思的</p>
<h2 id="第二层-Boneh-Durfee-attack"><a href="#第二层-Boneh-Durfee-attack" class="headerlink" title="第二层  Boneh_Durfee attack"></a>第二层  Boneh_Durfee attack</h2><p>这一层的私钥$d \approx 2^{256}$, 而$n \approx 2^{1024}$, 满足使用Boneh_Durfee attack的条件, 直接扔到脚本里跑就能跑出$d$来了<br>有了$d$直接解密即可</p>
<h2 id="第三层-Coppersmith’s-Short-pad-Attack"><a href="#第三层-Coppersmith’s-Short-pad-Attack" class="headerlink" title="第三层 Coppersmith’s Short-pad Attack"></a>第三层 Coppersmith’s Short-pad Attack</h2><p>第二层出来一个网站<code>https://dawn-whisper.lanzous.com/iCAv0lod7yj-password:gzjq&#39;</code>, 以及密码</p>
<p>打开后还是一道RSA</p>
<p>如题, e够小, 直接上脚本就行</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="comment"># 第一层</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">h = <span class="number">788785744509676701442642497798353940704045062680685297430840370664093043099033424646382070232242765761123110381200239132310785932203252095093993313010883982078216697297202940152563278231011836966627537170460186597134847633828107444548759805274516431300662852153808962421740187067058018192457264083227110866080267684557127718769967184710395811547902947248700889674967381917907905535103547918375731341071557144999864774198881339085314424766509424492349867615604684</span></span><br><span class="line">n = <span class="number">1246903000089073759886267722667196003041462505274526737638837808213476294697746018085346623497511017543801377442390781101585650581984057653018703031659844145960721073451379508212905335383758157379301019575213158532070229897587088955814288202279949391608732448294591675986989254272257059551622461096394217684402667140362275595245430242117193793913872208576714597860532581116390903216389172132085635891741189355461016795362341416848534340615825023292174042406128959</span></span><br><span class="line">c = <span class="number">952508462840095293368043281511747192551431448088755251878915582522463097721381421883702408853564036431155676272901680250701398946525803160765527940151587567521509500006089852079864042238196362897144754722623523621230744820970423076092319608853809407595863195726851921082224085255808985329769890887863865121647796115540376158135632760785321953364738008064130705467326745546629505023549047992509562623348749056757848144371814157305011884825502144329268299851210747</span></span><br><span class="line">ee = <span class="built_in">pow</span>(e, e)</span><br><span class="line">p = gcd(ee * h - <span class="number">1</span>, n)</span><br><span class="line">q = n // p ** <span class="number">2</span></span><br><span class="line">phi = (p - <span class="number">1</span>) * p * (q - <span class="number">1</span>)</span><br><span class="line">d = invert(e,phi)</span><br><span class="line">e = <span class="built_in">pow</span>(c, d, n)</span><br><span class="line">print(e)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二层</span></span><br><span class="line"><span class="comment"># Boneh_Durfee attack出的结果</span></span><br><span class="line"><span class="comment"># 脚本在https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/boneh_durfee.sage</span></span><br><span class="line">d = <span class="number">103079922798932082066165266087442072203677117380612800709240732626110126828541</span></span><br><span class="line">n = <span class="number">97814568264814384858194701955408461509880555772006698372422205341758322175891474378211599333051180365254844248340812534463000531890490435018379585036704801177155418066770861143206836558793774360498040810255823235715535487716966004194143204900564413879660115112965484824906920141847149888933004740523449213441</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">pow</span>(<span class="built_in">pow</span>(<span class="number">3</span>,e,n),d,n) == <span class="number">3</span></span><br><span class="line"></span><br><span class="line">c = <span class="number">86143311788363675684674113699193046781796638913243016152555572150858159500527674063754694514501999791875561142925154991000532628799185608465062814546108160434468098898040769021072007374156546314975240583347468026001633652940408779155579339470960571067652924814623371177901052302005289155305089588204204313261</span></span><br><span class="line">print(long_to_bytes(<span class="built_in">pow</span>(c,d,n)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三层</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_pad_attack</span>(<span class="params">c1, c2, e, n</span>):</span></span><br><span class="line">        PRxy.&lt;x,y&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">        PRx.&lt;xn&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">        PRZZ.&lt;xz,yz&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">        g1 = x^e - c1</span><br><span class="line">        g2 = (x+y)^e - c2</span><br><span class="line">        q1 = g1.change_ring(PRZZ)</span><br><span class="line">        q2 = g2.change_ring(PRZZ)</span><br><span class="line">        h = q2.resultant(q1)</span><br><span class="line">        h = h.univariate_polynomial()</span><br><span class="line">        h = h.change_ring(PRx).subs(y=xn)</span><br><span class="line">        h = h.monic()</span><br><span class="line">        kbits = n.nbits()//(<span class="number">2</span>*e*e)</span><br><span class="line">        diff = h.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> diff</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">related_message_attack</span>(<span class="params">c1, c2, diff, e, n</span>):</span></span><br><span class="line">    PRx.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    g1 = x^e - c1</span><br><span class="line">    g2 = (x+diff)^e - c2</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span>(<span class="params">g1, g2</span>):</span></span><br><span class="line">        <span class="keyword">while</span> g2:</span><br><span class="line">            g1, g2 = g2, g1 % g2</span><br><span class="line">        <span class="keyword">return</span> g1.monic()</span><br><span class="line">    <span class="keyword">return</span> -gcd(g1, g2)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">n = <span class="number">143224951702807798608353389056046982493788310072914995404719898237226283884553121669729599925829562704800197375580487019006702401282671268969358774635337351738915083955659230582177495821699251999928502338923489031347921151957398310960671307216790020399224115377846788378990638367296298663795893865325304226511</span></span><br><span class="line">e = <span class="number">7</span></span><br><span class="line">c1 = <span class="number">74797173657575640598140788410852016843612519588375968190579734420951374103129570637822547217967978911328419808529204143522454142303138959013220811558490951614314306849367068478190797885056922705403028856734095288522290055309880572321557493798362056216783777593386133347693892941928131945986087712737862263761</span></span><br><span class="line">c2 = <span class="number">9209695919437085323423940852135308337887271742988391422139555924185234849146079306139570263602339983687993333013333937719071267190971983543492940032646907167417161479697805991443259327402389097539126399994414628326218438416138199892253597375493026563369334352434282120293396846427418323600336867792587721214</span></span><br><span class="line">diff = short_pad_attack(c1, c2, e, n)</span><br><span class="line">m1 = related_message_attack(c1, c2, diff, e, n)</span><br><span class="line">long_to_bytes(m1)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># VNCTF&#123;H4ppyNeWy34r!2021_V&amp;N_figHt1ng!&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="0x01-strange-function"><a href="#0x01-strange-function" class="headerlink" title="0x01 strange function"></a>0x01 strange function</h1><h2 id="problem-1"><a href="#problem-1" class="headerlink" title="problem"></a>problem</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">MENU = <span class="string">br&#x27;&#x27;&#x27;[+] 1.function</span></span><br><span class="line"><span class="string">[+] 2.check_answer</span></span><br><span class="line"><span class="string">[+] 3.exit</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>(<span class="params">socketserver.BaseRequestHandler</span>):</span></span><br><span class="line">    <span class="comment"># 为了缩短篇幅, 这部分没有特别意义的函数就省略了</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span>(<span class="params">self</span>):</span></span><br><span class="line">        random.seed(os.urandom(<span class="number">8</span>))</span><br><span class="line">        proof = <span class="string">&#x27;&#x27;</span>.join([random.choice(string.ascii_letters+string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)])</span><br><span class="line">        _hexdigest = sha256(proof.encode()).hexdigest()</span><br><span class="line">        self.send(<span class="string">f&quot;[+] sha256(XXXX+<span class="subst">&#123;proof[<span class="number">4</span>:]&#125;</span>) == <span class="subst">&#123;_hexdigest&#125;</span>&quot;</span>.encode())</span><br><span class="line">        x = self.recv(prompt=<span class="string">b&#x27;[+] Plz tell me XXXX: &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(x) != <span class="number">4</span> <span class="keyword">or</span> sha256(x+proof[<span class="number">4</span>:].encode()).hexdigest() != _hexdigest:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">function</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.lenth):</span><br><span class="line">            numerator = <span class="built_in">ord</span>(self.token[i])</span><br><span class="line">            denominator = x - self.data[i]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                tmp = numerator / denominator</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.send(<span class="string">b&#x27;[+] Error!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            res += tmp</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">self</span>):</span></span><br><span class="line">        signal.alarm(<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.proof_of_work():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        self.send(<span class="string">b&#x27;[+] Welcome!&#x27;</span>)</span><br><span class="line">        self.send(<span class="string">b&#x27;[+] Can you find the flag through the calculating?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.score = <span class="number">0</span></span><br><span class="line">        self.token = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.ascii_letters + string.digits, <span class="number">16</span>))</span><br><span class="line">        self.lenth = <span class="built_in">len</span>(self.token)</span><br><span class="line">        self.data = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.lenth):</span><br><span class="line">            self.data.append(getRandomInteger(<span class="number">32</span>))</span><br><span class="line">        self.send(<span class="built_in">str</span>(self.data).encode())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.send(MENU, newline=<span class="literal">False</span>)</span><br><span class="line">            choice = self.recv()</span><br><span class="line">            <span class="keyword">if</span>(choice == <span class="string">b&#x27;1&#x27;</span>):</span><br><span class="line">                self.send(<span class="string">b&quot;[+] Plz give me your x: &quot;</span>)</span><br><span class="line">                now = <span class="built_in">int</span>(self.recv().strip().decode())</span><br><span class="line">                now = self.function(now)</span><br><span class="line">                self.send((<span class="string">&quot;[+] let me show you the answer: &quot;</span>+<span class="built_in">str</span>(now)).encode())</span><br><span class="line">            <span class="keyword">elif</span>(choice == <span class="string">b&#x27;2&#x27;</span>):</span><br><span class="line">                guess = self.recv().strip().decode()</span><br><span class="line">                <span class="keyword">if</span>(guess == self.token):</span><br><span class="line">                    self.score += <span class="number">1</span></span><br><span class="line">                    self.send(<span class="string">b&quot;[+] You win!&quot;</span>)</span><br><span class="line">                    self.send((<span class="string">&quot;[!] Now your score: &quot;</span> + <span class="built_in">str</span>(self.score)).encode())</span><br><span class="line"></span><br><span class="line">                    self.token = <span class="string">&#x27;&#x27;</span>.join([random.choice(string.digits + string.ascii_letters) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>((self.score+<span class="number">1</span>)*<span class="number">16</span>)])</span><br><span class="line">                    self.lenth = <span class="built_in">len</span>(self.token)</span><br><span class="line">                    self.data = []</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.lenth):</span><br><span class="line">                        self.data.append(getRandomInteger(<span class="number">32</span>))</span><br><span class="line">                    self.send(<span class="built_in">str</span>(self.data).encode())</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(self.score &gt;= <span class="number">5</span>):</span><br><span class="line">                        self.send(flag.encode())</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.send(<span class="string">b&#x27;[+] What do you want to say???&#x27;</span>)</span><br><span class="line">                    self.send(<span class="string">b&#x27;[!] Go away!&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        self.request.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    HOST, PORT = <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10002</span></span><br><span class="line">    server = ForkedServer((HOST, PORT), Task)</span><br><span class="line">    server.allow_reuse_address = <span class="literal">True</span></span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>先理一理这题在干嘛, 要我们干嘛<br>前面常规的工作量证明就不说了</p>
<p>每次访问服务端的时候, 会从<code>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</code>挑出16位作为<code>token</code></p>
<p>然后将<code>token</code>中的每一位的<code>ascii</code>码都乘一个不同的随机的数(范围在$(0,2^{32})$), 作为<code>data</code>然后发给客户端<br>客户端可以输入一个数$x$让服务端计算:<br>$$<br>token =[t_0,t_1,\cdots,t_n] \\<br>data = [d_0,d_1,\cdots,d_n] \\<br>A = {t_0 \over x - d_0} + {t_1 \over x - d_1} + \cdots + {t_n \over x - d_n}<br>$$<br> 并返回给客户端</p>
<p>解题的目标就是通过服务端返回的$A$,(可以重复输入不同的$x$获得不同的$A$<br>猜出五轮的$token$(每一轮$token$的位数都会增加</p>
<p>因为这里的$d_i$范围比较大, 所以每一个$d$都相差比较远, 当$x = d_i + 1$的时候,${t_i \over x - d_i} = t_i$ $|x - d_j| = |d_i + 1 - d_j|(j \ne i)$ 会特别大<br>所以事实上每次输入$x = d_i + 1$的时候, 有<br>$$<br>A_i = {t_0 \over d_i+1-d_0 } + {t_1 \over d_i+1 - d_1} + \cdots + {t_n \over d_i+1 - d_n} \approx {t_i}<br>$$<br>把每次的$A_i$四舍五入之后就是$t_i$了<br>所以每一轮把$x_0,x_1,\cdots,x_n$都发送一次, 就能得到$t_0,t_1,\cdots,t_n$了</p>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">printable = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof</span>(<span class="params">END, SHA</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> printable:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> printable:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> printable:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> printable:</span><br><span class="line">                    start = i + j + k + l</span><br><span class="line">                    ensha = sha256((start+END).encode()).hexdigest()</span><br><span class="line">                    <span class="keyword">if</span> ensha == SHA:</span><br><span class="line">                        print(start)</span><br><span class="line">                        <span class="keyword">return</span> start</span><br><span class="line"></span><br><span class="line">con = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">29406</span>)</span><br><span class="line">resp = con.recvuntil(<span class="string">&#x27;: &#x27;</span>).decode()</span><br><span class="line">END = re.findall(<span class="string">&#x27;XXXX\+(.*)\)&#x27;</span>,resp)[<span class="number">0</span>]</span><br><span class="line">SHA = re.findall(<span class="string">&#x27;== (.*)&#x27;</span>,resp)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">con.send(proof(END,SHA).encode())</span><br><span class="line">resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    token = []</span><br><span class="line">    array = re.findall(<span class="string">r&#x27;\d+&#x27;</span>, resp)</span><br><span class="line">    data = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> array:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(i) &gt; <span class="number">1</span>:</span><br><span class="line">            data.append(<span class="built_in">int</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        con.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">        con.sendline(<span class="built_in">str</span>(i + <span class="number">1</span>))</span><br><span class="line">        resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">        token.append(<span class="built_in">round</span>(<span class="built_in">float</span>(re.findall(<span class="string">r&#x27;let me show you the answer: (.*)&#x27;</span>, resp)[<span class="number">0</span>])))</span><br><span class="line">    print(token)</span><br><span class="line">    presend = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> token:</span><br><span class="line">        presend += <span class="built_in">chr</span>(i)</span><br><span class="line"></span><br><span class="line">    con.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">    con.sendline(presend)</span><br><span class="line">    resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">    print(resp)</span><br><span class="line"><span class="comment"># flag&#123;66a00c10-773f-4375-8a8e-444f0337bd31&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="0x02-strange-function-revenge"><a href="#0x02-strange-function-revenge" class="headerlink" title="0x02 strange_function_revenge"></a>0x02 strange_function_revenge</h1><h2 id="problem-2"><a href="#problem-2" class="headerlink" title="problem"></a>problem</h2><p>跟上一题的区别不大, 就不贴上来了</p>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>跟第一题的区别就在于随机数的大小变小了, 这样会导致每个$d$的差距不会太大, 再发送$x_i = d_i + 1$, 返回的$A_i$四舍五入就不一定是$t_i$了, 这里的解决办法就是对返回的$A_i$进行一次修正后再四舍五入</p>
<p>因为$token$是从<code>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</code>取的, 这些字符的<code>ascii</code>都是连在一起的, 平均数是<code>86</code>, 每次发送$x_i$的时候, 把除了$t_i$的其他$t$都当作<code>86</code>, 这样就可以计算出:<br>$$<br>offset_i = {86 \over d_i + 1 - d_0}+{86 \over d_i + 1 - d_1}+\cdots+{86 \over d_i + 1 - d_j} (i \ne j)<br>$$<br>这样就可以有!<br>$$<br>A_i - offset_i \approx t_i<br>$$<br>跟strange_function一样发送数据就行了<br>不过这个方法不太稳定, $offset$并不能保证每次都准确的修正$A$, 放一首好运来多跑几次吧<br>(大概跑了七八次吧….</p>
<h2 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">printable = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">A = <span class="number">86</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proof</span>(<span class="params">END, SHA</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> printable:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> printable:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> printable:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> printable:</span><br><span class="line">                    start = i + j + k + l</span><br><span class="line">                    ensha = sha256((start+END).encode()).hexdigest()</span><br><span class="line">                    <span class="keyword">if</span> ensha == SHA:</span><br><span class="line">                        print(start)</span><br><span class="line">                        <span class="keyword">return</span> start</span><br><span class="line"></span><br><span class="line">con = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27609</span>)</span><br><span class="line">resp = con.recvuntil(<span class="string">&#x27;: &#x27;</span>).decode()</span><br><span class="line">END = re.findall(<span class="string">&#x27;XXXX\+(.*)\)&#x27;</span>,resp)[<span class="number">0</span>]</span><br><span class="line">SHA = re.findall(<span class="string">&#x27;== (.*)&#x27;</span>,resp)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">con.send(proof(END,SHA).encode())</span><br><span class="line">resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    token = []</span><br><span class="line">    data = []</span><br><span class="line">    offset = []</span><br><span class="line">    array = re.findall(<span class="string">r&#x27;\d+&#x27;</span>, resp)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> array:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(i) &gt; <span class="number">1</span>:</span><br><span class="line">            data.append(<span class="built_in">int</span>(i))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        psend = i + <span class="number">1</span></span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">if</span> i != j:</span><br><span class="line">                <span class="built_in">sum</span> += A / (psend - j)</span><br><span class="line">        offset.append(<span class="built_in">sum</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        con.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">        resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">        con.sendline(<span class="built_in">str</span>(i + <span class="number">1</span>))</span><br><span class="line">        resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">        token.append(<span class="built_in">round</span>(<span class="built_in">float</span>(re.findall(<span class="string">r&#x27;let me show you the answer: (.*)&#x27;</span>, resp)[<span class="number">0</span>])-offset[data.index(i)]))</span><br><span class="line">    print(token)</span><br><span class="line">    presend = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> token:</span><br><span class="line">        presend += <span class="built_in">chr</span>(i)</span><br><span class="line"></span><br><span class="line">    con.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line"></span><br><span class="line">    con.sendline(presend)</span><br><span class="line">    resp = con.recvuntil(<span class="string">&#x27;[-] &#x27;</span>).decode()</span><br><span class="line">    print(resp)</span><br><span class="line"><span class="comment"># flag&#123;dfd7a22a-0ac7-4b7a-9dad-9d321fa2fcfa&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="0x03-fatcor"><a href="#0x03-fatcor" class="headerlink" title="0x03 fatcor"></a>0x03 fatcor</h1><blockquote>
<p>对着某个paper写了一下午的algorithm, 没做出来, tcltcltcl…..</p>
<p>等wp出来再总结一下</p>
<p>结果一个师傅教我了hh</p>
</blockquote>
<h2 id="problem-3"><a href="#problem-3" class="headerlink" title="problem"></a>problem</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_public_key</span>(<span class="params">d</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        p, q = getPrime(<span class="number">512</span>), getPrime(<span class="number">512</span>)</span><br><span class="line">        N, phi, not_phi = p * q, (p - <span class="number">1</span>) * (q - <span class="number">1</span>), (p + <span class="number">1</span>) * (q + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            e = inverse(d, not_phi)</span><br><span class="line">            <span class="keyword">assert</span> gcd(e, phi) == <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> (N, e)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">pubkey, m</span>):</span></span><br><span class="line">    N, e = pubkey</span><br><span class="line">    c = <span class="built_in">pow</span>(m, e, N)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">d = getPrime(<span class="number">300</span>)</span><br><span class="line">pubkeys = [get_public_key(d), get_public_key(d)]</span><br><span class="line">cs = encrypt(pubkeys[<span class="number">0</span>], m), encrypt(pubkeys[<span class="number">1</span>], m)</span><br><span class="line">print(pubkeys)</span><br><span class="line">print(cs)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">[(115483338707853323510117244601663937653032657454816581880428779391136584508645415322441921678179684904267659942318581245589538093236558206867210468172871004098796706517288570963560499418427771831765342801956281881820593084352360716457591198748797415842971188690055630073433785996545367137242661591939632740177, 57942961120648999071495995119939754708884253716257622598699627649519120883383654560602196191747110519111036450217116739928381611061803307053632035548944075112790103258912149703053932492832060534126356062378027983000713091223894604748395826345780826674822582205573649323340945351657354960324397873669889767611), (53622548101803784449246949981043962044702821559359430270342163843702543781580388956841660273746825211912789196955019345268896290156568895362182295889379787233440464948232717888315385094207004043907898658611926470834448875571292174245716821120409044389816082878077188546182422805778560826667364235348059795229, 37629174280947918845570975617525141920002123382327456934545962737176558640617579710289304146119507880547361939594011152968663070025066085778798378563965349218834887746411017240322083056673687330052590220772859205859051875687741541958997904176801239206348298021023694604932588913541173039972303193792987583003)]</span></span><br><span class="line"><span class="string">(51861394323132582263685584977796608641129485967610029542263453128833142621927008505594685713111162217651119546991411861320042282788909858323941435593508384080858965324662410947546608051702238057613339996124961723578887443100478753831786550701578678090466528863014222331341645240511640398819027209200809466160, 53200507591144017820710284362261363695745231005527161900426580605551005076410241969689161754211964469126847594337121140420040532547631617290907291418063708630323838133357597795892690304405706577096504918510233628396424543417886828387510407109281423448827267022542075484645277275676556239547911837897827866040)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>抄了那么久的paper居然是用格子做的! 感谢d33b4t0师傅指点才弄出这题</p>
<p>这题给出了一个300-bit的$d$, 再根据这个$d$生成了两套公钥$n_1,n_2,e_1,e_2$</p>
<p>关系式为<br>$$<br>e_1 \cdot d = 1 + k_1(p_1+1)(q_1+1) \\<br>e_2 \cdot d = 1 + k_2(p_2+1)(q_2+1)<br>$$<br>记$p_1+q_1+1 = s_1, p_2+q_2+1 = s_2$, 把式子化一下就有<br>$$<br>e_1 \cdot d - k_1n_1 = k_1s_1+1 \\<br>e_2 \cdot d - k_2n_2 = k_2s_2+1<br>$$<br>自己做的时候只用的其中的一个式子造二维格子, 结果死活都规约不出来(也不知道为啥, 以后能造三维就试试造三维吧.</p>
<p>用这两个式子造出一个三维格子<br>$$<br>(d ,-k_1,-k_2) =<br>\begin{pmatrix}<br>\sqrt n_1&amp;e_1&amp;e_2 \\<br>0&amp;n_1&amp;0 \\<br>0&amp;0&amp;n_2<br>\end{pmatrix}<br>=(d\sqrt n_1,k_1s_1+1,k_2s_2+1)<br>$$<br>(至于为啥有个$\sqrt n_1$, 当然是为了调整一下范数! 向量的长度也是合适的(得靠$d, k ,s$的位数来判断</p>
<p>通过规约这个格子, 有了$(d\sqrt n_1,k_1s_1+1,k_2s_2+1)$, 就能得出$d$</p>
<p>剩下的就是已知$e,d,n$求$phi$了, 不过这里的$d$有点不太一样注意一下就ok了</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes <span class="keyword">as</span> l2b ,isPrime</span><br><span class="line">n1 = <span class="number">115483338707853323510117244601663937653032657454816581880428779391136584508645415322441921678179684904267659942318581245589538093236558206867210468172871004098796706517288570963560499418427771831765342801956281881820593084352360716457591198748797415842971188690055630073433785996545367137242661591939632740177</span></span><br><span class="line">n2 = <span class="number">53622548101803784449246949981043962044702821559359430270342163843702543781580388956841660273746825211912789196955019345268896290156568895362182295889379787233440464948232717888315385094207004043907898658611926470834448875571292174245716821120409044389816082878077188546182422805778560826667364235348059795229</span></span><br><span class="line">e1 = <span class="number">57942961120648999071495995119939754708884253716257622598699627649519120883383654560602196191747110519111036450217116739928381611061803307053632035548944075112790103258912149703053932492832060534126356062378027983000713091223894604748395826345780826674822582205573649323340945351657354960324397873669889767611</span></span><br><span class="line">e2 = <span class="number">37629174280947918845570975617525141920002123382327456934545962737176558640617579710289304146119507880547361939594011152968663070025066085778798378563965349218834887746411017240322083056673687330052590220772859205859051875687741541958997904176801239206348298021023694604932588913541173039972303193792987583003</span></span><br><span class="line">half_n = <span class="built_in">round</span>(sqrt(n))</span><br><span class="line"></span><br><span class="line">L = Matrix([[half_n     ,e1  ,e2],</span><br><span class="line">            [<span class="number">0</span>       ,n1  ,<span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>       ,<span class="number">0</span>   ,n2]])</span><br><span class="line">res = L.LLL()[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">abs</span>(res[<span class="number">0</span>]) % half_n == <span class="number">0</span></span><br><span class="line">d = <span class="built_in">abs</span>(res[<span class="number">0</span>]) // half_n</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isPrime(d) :</span><br><span class="line">    knophi = e1 *d - <span class="number">1</span></span><br><span class="line">    nophi = knophi // (knophi // n1 )</span><br><span class="line">    pq = nophi - n - <span class="number">1</span></span><br><span class="line">    phi = n -pq +<span class="number">1</span></span><br><span class="line">    d1 = inverse_mod(e1,phi)</span><br><span class="line">    print(l2b(<span class="built_in">pow</span>(cs[<span class="number">0</span>],d1,n1)))</span><br><span class="line"><span class="comment"># b&#x27;vnctf&#123;7d47956b-bc55-4897-a550-cda0b221ce67&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这题做完感觉收获还是有的, 不像前面的几题</p>
<p>Lattice是一个神奇的东西, 一定要把所有方程写出来, 该联立的联立, 根据未知量和已知量以及这些数的位数,<br>造出合适的Lattice才能求出出题人想要我们规约出的那个最短向量来</p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://tearsjin.github.io">K1rit0</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://tearsjin.github.io/2021/03/14/writeup-for-2021VNCTF/">http://tearsjin.github.io/2021/03/14/writeup-for-2021VNCTF/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Crypto/">Crypto</a>
            <a href="/tags/RSA/">RSA</a>
            <a href="/tags/WirteUp/">WirteUp</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2021/03/21/The-learning-of-php-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">The learning of php 文件包含</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/2021/03/12/2020%E7%BA%B5%E6%A8%AA%E6%9D%AF-comon-Extending-Wiener-attack/">
        <span class="next-text nav-default">2020纵横杯 comon-Extending Wiener attack</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/tearsjin" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2020 - 2021<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">K1rit0</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
